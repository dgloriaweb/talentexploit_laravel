<?php

namespace App\Services;

use App\Job;
use App\JobDriversLicense;
use App\MatchHour;
use App\Person;
use App\Property;

class RateService
{

    //test function
    public static function getAllJobMatchRates()
    {
        //get all jobs from database
        $jobs = Job::all()->toArray();
        //calculate user match rate
        //get drivers rate, workprefs rate and return average

        $array = [
            [
                'job_id' => 1,
                'job_name' => 'welder',
                'job_rate' => '50%'
            ],
            [
                'job_id' => 2,
                'job_name' => 'tailor',
                'job_rate' => '70%'

            ]
        ];

        return $array;
    }

    public static function getWorkPrefRate($person_id, $job_id){
        //person codes
        //get the 5 digit code and pass it to the function to get code for person
        $hour_person_settings_code = PersonService::getPersonWorkPrefHourSettings($person_id);
        //pass the settings_code to the assoc table to get code
        $person_code = PersonService::getPersonWorkPrefHourCode($hour_person_settings_code);
        
        //job codes
        //get the 5 digit code and pass it to the function to get code for person
        $hour_job_settings_code = JobService::getJobWorkPrefHourSettings($job_id);
        //pass the settings_code to the assoc table to get code
        $job_code = JobService::getJobWorkPrefHourCode($hour_job_settings_code);
        //get result from hour weight database table
        //model: MatchHour, column name: job_code, row name: person_code
        //find row for user, and get the column data from that row
        $person_weights = MatchHour::where('user',$person_code)->first();
        $hour_weight=0;
        $attributes = array_keys($person_weights->getAttributes());
        foreach($attributes as $attribute){
            if ($attribute == $job_code){
                $hour_weight= $person_weights[$attribute];
                continue;
            }
        }


       
        $day_settings_code = PersonService::getPersonWorkPrefDaySettings($person_id);
       
       

    }



    /**
     * return string
     */
    public static function get_drivers_rate($person_id, $job_id)
    {
        //drivers license
        $person_drivers_licenses = Property::getDriversLicense($person_id);
        $array1 = [];
        foreach ($person_drivers_licenses as $person_drivers_license) {
            array_push($array1, $person_drivers_license->drivers_license['drivers_license']);
        }

        //get the job's drivers license array
        $job_drivers_licenses = JobDriversLicense::getJobDriversLicenses($job_id);

        $array2 = [];
        foreach ($job_drivers_licenses as $job_drivers_license) {
            array_push($array2, $job_drivers_license->driver['drivers_license']);
        }
        //if job license is none, then return empty array and return 100% match
        if ($array2[0] == 'none') {
            return  "100%";
        } else {
            //if there is other than none, compare arrays
            //check intersection of the two arrays
            $a = count($array2);
            $b = count(array_intersect($array2, $array1));
            $result = ($b / $a);
            //compare length of intersection array with job array length, return match in percentage
            return  intval($result * 100) . '%';
        }
    }
    public static function get_worprefs_rate($person_id, $job_id)
    {
        //old, simple way:
        //get data from persons, build an array
        $workprefs_array = Person::getFlatWorkprefsById($person_id);

        //get data from jobs, build an array
        $jobWorkprefs_array = Job::getFlatJobWorkprefsById($job_id);


        //new, enhanced way:
        //use matrix to calculate weighted rate
        //create code from user selection of hours
        //create code from user selection of days
        //compare match rate using the weight data



        //compare two arrays
        $a = count($jobWorkprefs_array);
        $b = count(array_intersect_assoc($jobWorkprefs_array, $workprefs_array));
        $result = ($b / $a);
        return intval($result * 100) . '%';
    }
}
