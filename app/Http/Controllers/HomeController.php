<?php

namespace App\Http\Controllers;

use App\Job;
use App\Person;
use App\Property;
use NumberFormatter;
use App\JobDriversLicense;
use Illuminate\Http\Request;

class HomeController extends Controller
{
    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function index()
    {
        $data = [
            'title' => 'Home'
        ];

        //want to add job name, job id and match score to frontend from here.
        //get jobs from database and mock a percentage.

        $jobs = Job::all();
        $jobs_array = [];
        //create array from job names and mock percentage
        foreach ($jobs as $job) {
            $jobs_array['jobs'][] =
                [
                    'job_name' => $job->job_name,
                    'rate' => '50%'
                ];
        }
        //add data to $data
        $data = array_merge($data, $jobs_array);
        return view('home',  $data);
    }

    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function dummyjob()
    {
        //user dummy ID is mine
        $person_id = 4;
        //user dummy job is 7
        $job_id = 7;
        $drivers_license_rate = $this->get_drivers_rate($person_id, $job_id);
        $data = [
            'title' => 'Dummyjob',
            'modaltitle' => 'edit work day, time and location preferences',
            'modaltext' => 'select or deselect preferred options.',
            'drivers_license_rate' => $drivers_license_rate,
        ];
        // add workprefs here
        $data = array_merge($data, $this->workprefs_array);

        return view('dummyjob', $data);
    }

    public function dummyworkprefs()
    {
        $data = [
            'title' => 'Work preferences'
        ];

        //store changes in the database
        return view('dummyjob', $data);
    }

    public function job_insight($id = null)
    {

        //define set of variables for blade        
        $data = [
            'title' => 'Job Insight',
            'modaltitle' => 'edit work day, time and location preferences',
            'modaltext' => 'select or deselect preferred options.',
            // add workprefs here from database
        ];
        //get user and it's work prefs.
        $person_id = session()->get('person_id');
        $workprefs_array = Person::getWorkprefsById($person_id);
        $data = array_merge($data, $workprefs_array);

        return view('job_insight', $data);
    }

    /**  
     * @param  \Illuminate\Http\Request $request
     * 
     */
    public function edit_workprefs(Request $request)
    {
        $data = [
            'title' => 'Job_insight'
        ];
        $person_id = session()->get('person_id');

        $array = [
            'workplace' => $request->input('workplace') == 'on' ? 1 : 0,
            'remote' => $request->input('remote') == 'on' ? 1 : 0,
            'workdays' => $request->input('workdays') == 'on' ? 1 : 0,
            'saturday' => $request->input('saturday') == 'on' ? 1 : 0,
            'sunday' => $request->input('sunday') == 'on' ? 1 : 0,
            'bank_holidays' => $request->input('bank_holidays') == 'on' ? 1 : 0,
            'sat_sun_bh_only' => $request->input('sat_sun_bh_only') == 'on' ? 1 : 0,
            'normal_hours' => $request->input('normal_hours') == 'on' ? 1 : 0,
            'nightshift' => $request->input('nightshift') == 'on' ? 1 : 0,
            'nightshift_only' => $request->input('nightshift_only') == 'on' ? 1 : 0,
            'other_shift' => $request->input('other_shift') == 'on' ? 1 : 0,
            'other_shift_only' => $request->input('other_shift_only') == 'on' ? 1 : 0,
            'overtime' => $request->input('overtime') == 'on' ? 1 : 0,
        ];

        if (Person::storeWorkPrefChanges($person_id, $array)) {


            return redirect('job_insight')->with('success', 'Data updated!');
        } else {
            return redirect('job_insight')->with('error', 'Something went wrong when updating work preferences. Data wasn\'t saved')
                ->withInput();
        }
    }

    /**
     * return string
     */
    public function get_drivers_rate($person_id, $job_id)
    {
        //drivers license
        $person_drivers_licenses = Property::getDriversLicense($person_id);
        $array1 = [];
        foreach ($person_drivers_licenses as $person_drivers_license) {
            array_push($array1, $person_drivers_license->drivers_license['drivers_license']);
        }

        //get the job's drivers license array
        $job_drivers_licenses = JobDriversLicense::getJobDriversLicenses($job_id);

        $array2 = [];
        foreach ($job_drivers_licenses as $job_drivers_license) {
            array_push($array2, $job_drivers_license->driver['drivers_license']);
        }
        //if job license is none, then return empty array and return 100% match
        if ($array2[0] == 'none') {
            return  "100%";
        } else {
            //if there is other than none, compare arrays
            //check intersection of the two arrays
            $a = count($array2);
            $b = count(array_intersect($array2, $array1));
            $result = ($b / $a);
            //compare length of intersection array with job array length, return match in percentage
            return  intval($result * 100) . '%';
        }
    }
}
